import { __awaiter } from "tslib";
import { Notice, Plugin, PluginSettingTab, Setting, } from "obsidian";
import ChatView, { inputId } from "./view";
import { Utils } from "./utils";
const DEFAULT_SETTINGS = {
    customName: "Dual",
};
export default class MyPlugin extends Plugin {
    onload() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loadSettings();
            this.registerView("chat", (leaf) => {
                return new ChatView(leaf, this.settings.customName);
            });
            this.app.workspace.layoutReady && this.initLeaf(this.app.workspace);
            this.registerEvent(this.app.workspace.on("layout-ready", () => this.initLeaf(this.app.workspace)));
            this.addSettingTab(new SampleSettingTab(this.app, this));
            this.addCommand({
                id: "focus-dual-input",
                name: "Focus Dual input box",
                callback: () => document.getElementById(inputId).focus(),
            });
        });
    }
    initLeaf(workspace) {
        if (workspace.getLeavesOfType("chat").length == 0) {
            workspace.getRightLeaf(false).setViewState({
                type: "chat",
            });
        }
    }
    loadSettings() {
        return __awaiter(this, void 0, void 0, function* () {
            this.settings = Object.assign({}, DEFAULT_SETTINGS, yield this.loadData());
        });
    }
    saveSettings() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.saveData(this.settings);
        });
    }
}
class SampleSettingTab extends PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.app = app;
        this.plugin = plugin;
    }
    display() {
        let { containerEl } = this;
        containerEl.empty();
        containerEl.createEl("h3", {
            text: "Follow these instructions to set up your Dual:",
        });
        new Setting(containerEl)
            .setName("RECIPE TEST")
            .setDesc("Press the button to head over to the download page.")
            .addButton((cb) => cb
            .setButtonText("TEST")
            .setClass("mod-cta")
            .onClick(() => __awaiter(this, void 0, void 0, function* () {
            alert("Testing");
        })));
        new Setting(containerEl)
            .setName("0. Install Python (3.8+).")
            .setDesc("Press the button to head over to the download page.")
            .addButton((cb) => cb
            .setButtonText("Install Python")
            .setClass("mod-cta")
            .onClick(() => {
            window.open("https://www.python.org/downloads/");
        }));
        new Setting(containerEl)
            .setName("1. Copy snapshot.")
            .setDesc("Press the button to copy the entire vault as concatenated plain text.")
            .addButton((cb) => cb
            .setButtonText("Copy snapshot")
            .setClass("mod-cta")
            .onClick(() => {
            new Notice("Loading files...");
            let concatenated = "";
            // TODO Use Promise.all() / map / reduce
            this.app.vault.getMarkdownFiles().forEach((element) => {
                this.app.vault.cachedRead(element).then((res) => {
                    res = res
                        .replace(/^---[\s\S]*---\n*/g, "")
                        .replace(/\[\[[^\|\[\]]*\|([^\|\[\]]*)\]\]/g, "$1")
                        .replace(/\[\[(.*)\]\]/g, "$1")
                        .replace(/```([^`])*```\n*/g, "")
                        .replace(/\$([^$])*\$*/g, "");
                    concatenated = concatenated.concat(res, "\n\n");
                });
            });
            let copyPromise = new Promise((resolve) => setTimeout(resolve, 3000)).then(() => {
                concatenated = concatenated.slice(0, 5000000);
                concatenated = Utils.removeMd(concatenated);
                Utils.copyStringToClipboard(concatenated);
                new Notice("Snapshot successfully copied to clipboard!");
            });
        }));
        new Setting(containerEl)
            .setName("2. Derive the essence.")
            .setDesc("After following the online instructions, extract 'essence.zip' in '.obsidian/plugins/Dual/'.")
            .addButton((cb) => cb
            .setButtonText("Start alignment")
            .setClass("mod-cta")
            .onClick(() => {
            window.open("https://colab.research.google.com/drive/1CObehan5gmYO-TvyyYq973a3h-_EYr9_?usp=sharing");
        }));
        new Setting(containerEl)
            .setName("3. Configure the skeleton.")
            .setDesc("Run 'python3 -m pip install -r requirements.txt' in '.obsidian/plugins/Dual/skeleton/'.");
        new Setting(containerEl)
            .setName("4. Run the skeleton after you configured the essence.")
            .setDesc("Run 'python3 server.py --path /path/to/your/vault/' in '.obsidian/plugins/Dual/skeleton/'.");
        new Setting(containerEl)
            .setName("5. Restart Obsidian.")
            .setDesc("Head over to the right side panel to talk with your Dual!");
        containerEl.createEl("h3", {
            text: "Congratulations on setting up your Dual!",
        });
        new Setting(containerEl)
            .setName("Custom name")
            .setDesc("Customize your Dual's name using the input box. Reload Obsidian for this to take effect.")
            .addText((text) => text
            .setPlaceholder("Dual")
            .setValue("")
            .onChange((value) => __awaiter(this, void 0, void 0, function* () {
            this.plugin.settings.customName = value;
            yield this.plugin.saveSettings();
        })));
        new Setting(containerEl)
            .setName("Get involved!")
            .addButton((cb) => cb
            .setButtonText("Report bugs")
            .setClass("mod-cta")
            .onClick(() => {
            window.open("https://github.com/Psionica/Dual/issues");
        }))
            .addButton((cb) => cb
            .setButtonText("Join Psionica")
            .setClass("mod-cta")
            .onClick(() => {
            window.open("https://psionica.org/");
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1haW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFFTCxNQUFNLEVBQ04sTUFBTSxFQUNOLGdCQUFnQixFQUNoQixPQUFPLEdBRVIsTUFBTSxVQUFVLENBQUM7QUFDbEIsT0FBTyxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQU1oQyxNQUFNLGdCQUFnQixHQUFxQjtJQUN6QyxVQUFVLEVBQUUsTUFBTTtDQUNuQixDQUFDO0FBRUYsTUFBTSxDQUFDLE9BQU8sT0FBTyxRQUFTLFNBQVEsTUFBTTtJQUdwQyxNQUFNOztZQUNWLE1BQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRTFCLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7Z0JBQ2pDLE9BQU8sSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDdEQsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxhQUFhLENBQ2hCLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FDbEMsQ0FDRixDQUFDO1lBRUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUV6RCxJQUFJ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SUFBSSxPQUFPLENBQUMsV0FBVyxDQUFDO2FBQ3JCLE9BQU8sQ0FBQyxlQUFlLENBQUM7YUFDeEIsU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDaEIsRUFBRTthQUNDLGFBQWEsQ0FBQyxhQUFhLENBQUM7YUFDNUIsUUFBUSxDQUFDLFNBQVMsQ0FBQzthQUNuQixPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ1osTUFBTSxDQUFDLElBQUksQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1FBQ3pELENBQUMsQ0FBQyxDQUNMO2FBQ0EsU0FBUyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FDaEIsRUFBRTthQUNDLGFBQWEsQ0FBQyxlQUFlLENBQUM7YUFDOUIsUUFBUSxDQUFDLFNBQVMsQ0FBQzthQUNuQixPQUFPLENBQUMsR0FBRyxFQUFFO1lBQ1osTUFBTSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDTixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBcHAsXG4gIE5vdGljZSxcbiAgUGx1Z2luLFxuICBQbHVnaW5TZXR0aW5nVGFiLFxuICBTZXR0aW5nLFxuICBXb3Jrc3BhY2UsXG59IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IENoYXRWaWV3LCB7IGlucHV0SWQgfSBmcm9tIFwiLi92aWV3XCI7XG5pbXBvcnQgeyBVdGlscyB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbmludGVyZmFjZSBNeVBsdWdpblNldHRpbmdzIHtcbiAgY3VzdG9tTmFtZTogc3RyaW5nO1xufVxuXG5jb25zdCBERUZBVUxUX1NFVFRJTkdTOiBNeVBsdWdpblNldHRpbmdzID0ge1xuICBjdXN0b21OYW1lOiBcIkR1YWxcIixcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE15UGx1Z2luIGV4dGVuZHMgUGx1Z2luIHtcbiAgc2V0dGluZ3M6IE15UGx1Z2luU2V0dGluZ3M7XG5cbiAgYXN5bmMgb25sb2FkKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZFNldHRpbmdzKCk7XG5cbiAgICB0aGlzLnJlZ2lzdGVyVmlldyhcImNoYXRcIiwgKGxlYWYpID0+IHtcbiAgICAgIHJldHVybiBuZXcgQ2hhdFZpZXcobGVhZiwgdGhpcy5zZXR0aW5ncy5jdXN0b21OYW1lKTtcbiAgICB9KTtcblxuICAgIHRoaXMuYXBwLndvcmtzcGFjZS5sYXlvdXRSZWFkeSAmJiB0aGlzLmluaXRMZWFmKHRoaXMuYXBwLndvcmtzcGFjZSk7XG4gICAgdGhpcy5yZWdpc3RlckV2ZW50KFxuICAgICAgdGhpcy5hcHAud29ya3NwYWNlLm9uKFwibGF5b3V0LXJlYWR5XCIsICgpID0+XG4gICAgICAgIHRoaXMuaW5pdExlYWYodGhpcy5hcHAud29ya3NwYWNlKVxuICAgICAgKVxuICAgICk7XG5cbiAgICB0aGlzLmFkZFNldHRpbmdUYWIobmV3IFNhbXBsZVNldHRpbmdUYWIodGhpcy5hcHAsIHRoaXMpKTtcblxuICAgIHRoaXMuYWRkQ29tbWFuZCh7XG4gICAgICBpZDogXCJmb2N1cy1kdWFsLWlucHV0XCIsXG4gICAgICBuYW1lOiBcIkZvY3VzIER1YWwgaW5wdXQgYm94XCIsXG4gICAgICBjYWxsYmFjazogKCkgPT4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaW5wdXRJZCkuZm9jdXMoKSxcbiAgICB9KTtcbiAgfVxuXG4gIGluaXRMZWFmKHdvcmtzcGFjZTogV29ya3NwYWNlKTogdm9pZCB7XG4gICAgaWYgKHdvcmtzcGFjZS5nZXRMZWF2ZXNPZlR5cGUoXCJjaGF0XCIpLmxlbmd0aCA9PSAwKSB7XG4gICAgICB3b3Jrc3BhY2UuZ2V0UmlnaHRMZWFmKGZhbHNlKS5zZXRWaWV3U3RhdGUoe1xuICAgICAgICB0eXBlOiBcImNoYXRcIixcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGxvYWRTZXR0aW5ncygpIHtcbiAgICB0aGlzLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9TRVRUSU5HUywgYXdhaXQgdGhpcy5sb2FkRGF0YSgpKTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVTZXR0aW5ncygpIHtcbiAgICBhd2FpdCB0aGlzLnNhdmVEYXRhKHRoaXMuc2V0dGluZ3MpO1xuICB9XG59XG5cbmNsYXNzIFNhbXBsZVNldHRpbmdUYWIgZXh0ZW5kcyBQbHVnaW5TZXR0aW5nVGFiIHtcbiAgcGx1Z2luOiBNeVBsdWdpbjtcblxuICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcGx1Z2luOiBNeVBsdWdpbikge1xuICAgIHN1cGVyKGFwcCwgcGx1Z2luKTtcbiAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB0aGlzLnBsdWdpbiA9IHBsdWdpbjtcbiAgfVxuXG4gIGRpc3BsYXkoKTogdm9pZCB7XG4gICAgbGV0IHsgY29udGFpbmVyRWwgfSA9IHRoaXM7XG5cbiAgICBjb250YWluZXJFbC5lbXB0eSgpO1xuXG4gICAgY29udGFpbmVyRWwuY3JlYXRlRWwoXCJoM1wiLCB7XG4gICAgICB0ZXh0OiBcIkZvbGxvdyB0aGVzZSBpbnN0cnVjdGlvbnMgdG8gc2V0IHVwIHlvdXIgRHVhbDpcIixcbiAgICB9KTtcblxuICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxuICAgICAgLnNldE5hbWUoXCJSRUNJUEUgVEVTVFwiKVxuICAgICAgLnNldERlc2MoXCJQcmVzcyB0aGUgYnV0dG9uIHRvIGhlYWQgb3ZlciB0byB0aGUgZG93bmxvYWQgcGFnZS5cIilcbiAgICAgIC5hZGRCdXR0b24oKGNiKSA9PlxuICAgICAgICBjYlxuICAgICAgICAgIC5zZXRCdXR0b25UZXh0KFwiVEVTVFwiKVxuICAgICAgICAgIC5zZXRDbGFzcyhcIm1vZC1jdGFcIilcbiAgICAgICAgICAub25DbGljayhhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBhbGVydChcIlRlc3RpbmdcIik7XG4gICAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiMC4gSW5zdGFsbCBQeXRob24gKDMuOCspLlwiKVxuICAgICAgLnNldERlc2MoXCJQcmVzcyB0aGUgYnV0dG9uIHRvIGhlYWQgb3ZlciB0byB0aGUgZG93bmxvYWQgcGFnZS5cIilcbiAgICAgIC5hZGRCdXR0b24oKGNiKSA9PlxuICAgICAgICBjYlxuICAgICAgICAgIC5zZXRCdXR0b25UZXh0KFwiSW5zdGFsbCBQeXRob25cIilcbiAgICAgICAgICAuc2V0Q2xhc3MoXCJtb2QtY3RhXCIpXG4gICAgICAgICAgLm9uQ2xpY2soKCkgPT4ge1xuICAgICAgICAgICAgd2luZG93Lm9wZW4oXCJodHRwczovL3d3dy5weXRob24ub3JnL2Rvd25sb2Fkcy9cIik7XG4gICAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiMS4gQ29weSBzbmFwc2hvdC5cIilcbiAgICAgIC5zZXREZXNjKFxuICAgICAgICBcIlByZXNzIHRoZSBidXR0b24gdG8gY29weSB0aGUgZW50aXJlIHZhdWx0IGFzIGNvbmNhdGVuYXRlZCBwbGFpbiB0ZXh0LlwiXG4gICAgICApXG4gICAgICAuYWRkQnV0dG9uKChjYikgPT5cbiAgICAgICAgY2JcbiAgICAgICAgICAuc2V0QnV0dG9uVGV4dChcIkNvcHkgc25hcHNob3RcIilcbiAgICAgICAgICAuc2V0Q2xhc3MoXCJtb2QtY3RhXCIpXG4gICAgICAgICAgLm9uQ2xpY2soKCkgPT4ge1xuICAgICAgICAgICAgbmV3IE5vdGljZShcIkxvYWRpbmcgZmlsZXMuLi5cIik7XG5cbiAgICAgICAgICAgIGxldCBjb25jYXRlbmF0ZWQgPSBcIlwiO1xuXG4gICAgICAgICAgICAvLyBUT0RPIFVzZSBQcm9taXNlLmFsbCgpIC8gbWFwIC8gcmVkdWNlXG5cbiAgICAgICAgICAgIHRoaXMuYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKS5mb3JFYWNoKChlbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuYXBwLnZhdWx0LmNhY2hlZFJlYWQoZWxlbWVudCkudGhlbigocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgcmVzID0gcmVzXG4gICAgICAgICAgICAgICAgICAucmVwbGFjZSgvXi0tLVtcXHNcXFNdKi0tLVxcbiovZywgXCJcIilcbiAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXFtcXFtbXlxcfFxcW1xcXV0qXFx8KFteXFx8XFxbXFxdXSopXFxdXFxdL2csIFwiJDFcIilcbiAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXFtcXFsoLiopXFxdXFxdL2csIFwiJDFcIilcbiAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9gYGAoW15gXSkqYGBgXFxuKi9nLCBcIlwiKVxuICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1xcJChbXiRdKSpcXCQqL2csIFwiXCIpO1xuXG4gICAgICAgICAgICAgICAgY29uY2F0ZW5hdGVkID0gY29uY2F0ZW5hdGVkLmNvbmNhdChyZXMsIFwiXFxuXFxuXCIpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBsZXQgY29weVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT5cbiAgICAgICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCAzMDAwKVxuICAgICAgICAgICAgKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgY29uY2F0ZW5hdGVkID0gY29uY2F0ZW5hdGVkLnNsaWNlKDAsIDUwMDAwMDApO1xuICAgICAgICAgICAgICBjb25jYXRlbmF0ZWQgPSBVdGlscy5yZW1vdmVNZChjb25jYXRlbmF0ZWQpO1xuICAgICAgICAgICAgICBVdGlscy5jb3B5U3RyaW5nVG9DbGlwYm9hcmQoY29uY2F0ZW5hdGVkKTtcbiAgICAgICAgICAgICAgbmV3IE5vdGljZShcIlNuYXBzaG90IHN1Y2Nlc3NmdWxseSBjb3BpZWQgdG8gY2xpcGJvYXJkIVwiKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG4gICAgICAuc2V0TmFtZShcIjIuIERlcml2ZSB0aGUgZXNzZW5jZS5cIilcbiAgICAgIC5zZXREZXNjKFxuICAgICAgICBcIkFmdGVyIGZvbGxvd2luZyB0aGUgb25saW5lIGluc3RydWN0aW9ucywgZXh0cmFjdCAnZXNzZW5jZS56aXAnIGluICcub2JzaWRpYW4vcGx1Z2lucy9EdWFsLycuXCJcbiAgICAgIClcbiAgICAgIC5hZGRCdXR0b24oKGNiKSA9PlxuICAgICAgICBjYlxuICAgICAgICAgIC5zZXRCdXR0b25UZXh0KFwiU3RhcnQgYWxpZ25tZW50XCIpXG4gICAgICAgICAgLnNldENsYXNzKFwibW9kLWN0YVwiKVxuICAgICAgICAgIC5vbkNsaWNrKCgpID0+IHtcbiAgICAgICAgICAgIHdpbmRvdy5vcGVuKFxuICAgICAgICAgICAgICBcImh0dHBzOi8vY29sYWIucmVzZWFyY2guZ29vZ2xlLmNvbS9kcml2ZS8xQ09iZWhhbjVnbVlPLVR2eXlZcTk3M2EzaC1fRVlyOV8/dXNwPXNoYXJpbmdcIlxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9KVxuICAgICAgKTtcblxuICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxuICAgICAgLnNldE5hbWUoXCIzLiBDb25maWd1cmUgdGhlIHNrZWxldG9uLlwiKVxuICAgICAgLnNldERlc2MoXG4gICAgICAgIFwiUnVuICdweXRob24zIC1tIHBpcCBpbnN0YWxsIC1yIHJlcXVpcmVtZW50cy50eHQnIGluICcub2JzaWRpYW4vcGx1Z2lucy9EdWFsL3NrZWxldG9uLycuXCJcbiAgICAgICk7XG5cbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiNC4gUnVuIHRoZSBza2VsZXRvbiBhZnRlciB5b3UgY29uZmlndXJlZCB0aGUgZXNzZW5jZS5cIilcbiAgICAgIC5zZXREZXNjKFxuICAgICAgICBcIlJ1biAncHl0aG9uMyBzZXJ2ZXIucHkgLS1wYXRoIC9wYXRoL3RvL3lvdXIvdmF1bHQvJyBpbiAnLm9ic2lkaWFuL3BsdWdpbnMvRHVhbC9za2VsZXRvbi8nLlwiXG4gICAgICApO1xuXG4gICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG4gICAgICAuc2V0TmFtZShcIjUuIFJlc3RhcnQgT2JzaWRpYW4uXCIpXG4gICAgICAuc2V0RGVzYyhcIkhlYWQgb3ZlciB0byB0aGUgcmlnaHQgc2lkZSBwYW5lbCB0byB0YWxrIHdpdGggeW91ciBEdWFsIVwiKTtcblxuICAgIGNvbnRhaW5lckVsLmNyZWF0ZUVsKFwiaDNcIiwge1xuICAgICAgdGV4dDogXCJDb25ncmF0dWxhdGlvbnMgb24gc2V0dGluZyB1cCB5b3VyIER1YWwhXCIsXG4gICAgfSk7XG5cbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiQ3VzdG9tIG5hbWVcIilcbiAgICAgIC5zZXREZXNjKFxuICAgICAgICBcIkN1c3RvbWl6ZSB5b3VyIER1YWwncyBuYW1lIHVzaW5nIHRoZSBpbnB1dCBib3guIFJlbG9hZCBPYnNpZGlhbiBmb3IgdGhpcyB0byB0YWtlIGVmZmVjdC5cIlxuICAgICAgKVxuICAgICAgLmFkZFRleHQoKHRleHQpID0+XG4gICAgICAgIHRleHRcbiAgICAgICAgICAuc2V0UGxhY2Vob2xkZXIoXCJEdWFsXCIpXG4gICAgICAgICAgLnNldFZhbHVlKFwiXCIpXG4gICAgICAgICAgLm9uQ2hhbmdlKGFzeW5jICh2YWx1ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5wbHVnaW4uc2V0dGluZ3MuY3VzdG9tTmFtZSA9IHZhbHVlO1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5wbHVnaW4uc2F2ZVNldHRpbmdzKCk7XG4gICAgICAgICAgfSlcbiAgICAgICk7XG5cbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiR2V0IGludm9sdmVkIVwiKVxuICAgICAgLmFkZEJ1dHRvbigoY2IpID0+XG4gICAgICAgIGNiXG4gICAgICAgICAgLnNldEJ1dHRvblRleHQoXCJSZXBvcnQgYnVnc1wiKVxuICAgICAgICAgIC5zZXRDbGFzcyhcIm1vZC1jdGFcIilcbiAgICAgICAgICAub25DbGljaygoKSA9PiB7XG4gICAgICAgICAgICB3aW5kb3cub3BlbihcImh0dHBzOi8vZ2l0aHViLmNvbS9Qc2lvbmljYS9EdWFsL2lzc3Vlc1wiKTtcbiAgICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLmFkZEJ1dHRvbigoY2IpID0+XG4gICAgICAgIGNiXG4gICAgICAgICAgLnNldEJ1dHRvblRleHQoXCJKb2luIFBzaW9uaWNhXCIpXG4gICAgICAgICAgLnNldENsYXNzKFwibW9kLWN0YVwiKVxuICAgICAgICAgIC5vbkNsaWNrKCgpID0+IHtcbiAgICAgICAgICAgIHdpbmRvdy5vcGVuKFwiaHR0cHM6Ly9wc2lvbmljYS5vcmcvXCIpO1xuICAgICAgICAgIH0pXG4gICAgICApO1xuICB9XG59XG4iXX0=